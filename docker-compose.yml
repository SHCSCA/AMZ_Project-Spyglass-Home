version: '3.8'

x-environment-defaults: &env_defaults
  VITE_API_BASE_URL: ${VITE_API_BASE_URL:-}
  APP_VERSION: ${APP_VERSION-latest}

services:
  frontend:
    build:
      context: .
      args:
        # 构建时注入（静态编译进 bundle）- 默认留空使用相对路径
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-}
        APP_BUILD_TIME: ${APP_BUILD_TIME}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    image: spyglass-frontend:${APP_VERSION:-latest}
    container_name: spyglass-frontend
    ports:
      # 将宿主机 FRONTEND_PORT (默认 8082) 映射到容器 80 (Nginx)
      - "${FRONTEND_PORT:-8082}:80"
    environment: *env_defaults
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost/version.json" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - spyglass-net
    labels:
      com.spyglass.role: frontend
      com.spyglass.api-base: ${VITE_API_BASE_URL:-/api}
    depends_on: []

networks:
  spyglass-net:
    driver: bridge
